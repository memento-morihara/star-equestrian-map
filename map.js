import {
	food,
	collectibles,
	resources,
	chests,
	other
} from './markers.js';
import locations from './locations.js';
import { initFilter, updateShownItems } from './data.js';

// // Autogenerated code from MapTiler
const mapExtent = [ 0.00000000, -16384.00000000, 16384.00000000, 0.00000000 ];
const mapMinZoom = 0;
const mapMaxZoom = 4;
const mapMaxResolution = 2.00000000;
const mapMinResolution = Math.pow(2, mapMaxZoom) * mapMaxResolution;
const tileExtent = [ 0.00000000, -16384.00000000, 16384.00000000, 0.00000000 ];
const crs = L.CRS.Simple;
crs.transformation = new L.Transformation(1, -tileExtent[ 0 ], -1, tileExtent[ 3 ]);
crs.scale = function (zoom) {
	return Math.pow(2, zoom) / mapMinResolution;
};
crs.zoom = function (scale) {
	return Math.log(scale * mapMinResolution) / Math.LN2;
};
let map = new L.Map('map', {
	maxZoom: mapMaxZoom,
	minZoom: mapMinZoom,
	crs: crs,
	condensedAttributionControl: false
});

L.tileLayer('./tiles/{z}/{x}/{y}.webp', {
	minZoom: mapMinZoom, maxZoom: mapMaxZoom,
	tileSize: L.point(512, 512),
	attribution: '<a href="https://www.maptiler.com/engine/">Rendered with MapTiler Engine</a>, non-commercial use only',
	noWrap: true,
	tms: false
}).addTo(map);
map.fitBounds([
	crs.unproject(L.point(mapExtent[ 2 ], mapExtent[ 3 ])),
	crs.unproject(L.point(mapExtent[ 0 ], mapExtent[ 1 ]))
]);
L.control.mousePosition().addTo(map)

const oms = new OverlappingMarkerSpiderfier(map, {
	keepSpiderfied: true,
	legColors: {
		usual: "white",
		highlighted: "red"
	}
});

let selectedMarker;

let foodFeatureGroup = L.featureGroup().addTo(map);
let resourcesFeatureGroup = L.featureGroup().addTo(map);
let chestsFeatureGroup = L.featureGroup().addTo(map);
let collectiblesFeatureGroup = L.featureGroup().addTo(map);
let otherFeatureGroup = L.featureGroup().addTo(map);


export function newMarker(loc, name, description, id) {
	const obj = [ food, resources, chests, collectibles, other ].flat().find(x => x.name === name);
	const marker = L.marker(loc, {
		name: name,
		description: description,
		id: id,
		riseOnHover: true,
		icon: (obj && obj.icon) || L.icon({
			iconUrl: './se-marker.svg',
		}),
	})
	marker.bindPopup(`<h2 class="marker-title">${name}</h2><p>${description ?? ""}`);
	oms.addMarker(marker);
	// addFeatures(marker);
	marker.on('contextmenu click', () => {
		selectedMarker = marker;
		console.log(selectedMarker)
	});

	return marker;
}

// Prevent marker popup when clicking on a group of markers
oms.addListener('spiderfy', function () {
	map.closePopup();
});

let markers = [];

async function getMarkers() {
	let list = locations;
	for (let location of list) {
		let marker = newMarker([ location.lat, location.lng ], location.name, location.description, location.id);
		markers.push(marker);
	}
}

//Get the name of the objects in the arrays to compare against the marker's name
let groups = [ food, resources, chests, collectibles, other ].map(x => x.map(y => y.name));

function divideIntoGroups(marker) {
	// Find the index of the group in the groups array that contains the marker's name
	switch (groups.indexOf(groups.find(g => g.includes(marker.options.name)))) {
		case 0:
			return foodFeatureGroup;
		case 1:
			return resourcesFeatureGroup;
		case 2:
			return chestsFeatureGroup;
		case 3:
			return collectiblesFeatureGroup;
		case 4:
			return otherFeatureGroup;
	}
};


function addFeatures(marker) {
	divideIntoGroups(marker).addLayer(marker);
}

map.whenReady(getMarkers)
initMapMarkers();

function initMapMarkers() {
	initFilter().map(x => valueToMarker(x).map(y => toggleMarker(y)));
}

function toggleMarkerGroup(markerGroup) {
	map.hasLayer(markerGroup) ? markerGroup.remove() : markerGroup.addTo(map);
}

function toggleMarker(marker) {
	map.hasLayer(marker) ? marker.remove() : marker.addTo(map);
}

let visibleFeatures = []

function valueToMarker(name) {
	return markers.filter(marker => marker.options.name.toLowerCase().split(" ").join("-") === name.toLowerCase());
}

let checkboxes = document.querySelectorAll("input[type=checkbox]")
checkboxes.forEach(c => {
	c.checked && visibleFeatures.push({
		name: c.value,
		group: c.getAttribute("data-feature-group")
	});
	c.addEventListener("change", function (e) {
		// TODO: refactor to use FeatureGroups for each type of item
		valueToMarker(e.target.value).forEach(marker => toggleMarker(marker));
		// Update the shownItems array in localStorage
		updateShownItems(e.target.checked, c.value);
	})
})

L.control.condensedAttribution({
	prefix: `Images &copy; <a href="https://www.foxieventures.com">Foxie Ventures</a>`
}).addTo(map)

L.control.sidepanel('menu', {
	hasTabs: true,
}).addTo(map);
